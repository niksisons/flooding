# Геопортал для мониторинга затоплений

Веб-платформа для анализа, мониторинга и визуализации зон затопления на основе спутниковых снимков и цифровых моделей рельефа (DEM). Проект предназначен для специалистов МЧС, экологов, муниципалитетов и всех, кто занимается анализом паводков и ЧС, а также для широкой публики.

---

## Описание и назначение

**Геопортал** позволяет:
- Загружать и хранить космические снимки и DEM-файлы
- Выполнять автоматический анализ затопления с помощью современных алгоритмов
- Визуализировать результаты на интерактивной карте (Leaflet)
- Получать статистику по затопленным территориям
- Сравнивать результаты по разным источникам (DEM, MNDWI)
- Управлять доступом и ролями пользователей

### Используемые технологии
- **Бэкенд:** Django, Django REST Framework, GeoDjango
- **База данных:** PostgreSQL + PostGIS
- **Обработка геоданных:** GDAL, Rasterio, Geopandas, Pysheds, Shapely, Fiona
- **Очереди задач:** Celery, django-background-tasks, Redis
- **Фронтенд:** Django Templates, Leaflet.js, HTML5, CSS3, JS
- **Интеграции:** (опционально) GeoServer, WMS/WFS

---

## Архитектура и структура

- `floodportal/` — основной Django-проект (настройки, маршруты)
- `flooddata/` — приложение для работы с анализом затоплений, загрузкой данных, API
- `templates/` — HTML-шаблоны (карта, загрузка, анализ, регистрация и др.)
- `static/` — CSS, JS, изображения
- `media/` — пользовательские файлы (DEM, снимки, результаты)

---

## Алгоритм анализа затопления

1. **Загрузка данных:**
   - Пользователь загружает DEM-файл (GeoTIFF) и спутниковые снимки (обычно два канала: Green и SWIR2).
2. **Извлечение маски воды по снимку:**
   - Вычисляется индекс MNDWI (Normalized Difference Water Index) по каналам Green и SWIR2.
   - Полученная маска бинаризуется (выделяются водные объекты).
3. **Маска воды по DEM:**
   - По DEM выделяются области с высотой ниже порога (например, 0 м).
   - Маска DEM приводится к размеру снимка.
4. **Сравнение масок:**
   - Выделяются три зоны: затопление только по DEM, только по снимку, совпадающие зоны.
5. **Векторизация:**
   - Маски преобразуются в векторные слои (GeoJSON, MultiPolygon).
6. **Расчёт статистики:**
   - Площадь затопления по каждой маске, совпадения, статистика по районам (если загружены административные границы).
7. **Визуализация:**
   - Результаты отображаются на карте, доступны для скачивания и анализа.

**Технологии и библиотеки:** Rasterio, Numpy, Scikit-Image, Geopandas, Shapely, GDAL.

---

## Роли пользователей и разграничение доступа

- **Гость:** просмотр карты, истории затоплений, регистрация
- **Пользователь:** загрузка данных, запуск анализа, просмотр своих результатов
- **Администратор:** управление всеми слоями, анализами, пользователями, модерация

---

## Функциональные возможности

### Для всех пользователей
- Просмотр интерактивной карты с зонами затопления
- Исторические события, статистика
- Регистрация, авторизация

### Для зарегистрированных пользователей
- Загрузка DEM и спутниковых снимков
- Создание и запуск анализа затопления
- Просмотр и скачивание результатов
- Получение статистики по анализу

### Для администраторов
- Управление пользователями и их правами
- Модерация и удаление данных
- Управление базовыми слоями и анализами

---

## Установка и запуск

### Предварительные требования
- Python 3.8+
- PostgreSQL с расширением PostGIS
- GDAL (рекомендуется >=3.10)
- Visual C++ Build Tools (Windows)

### Особенности установки на Windows
- **GDAL:** скачайте wheel-файл с https://www.lfd.uci.edu/~gohlke/pythonlibs/#gdal и установите через `pip install <имя_wheel>`
- **PostGIS:** используйте официальный инсталлятор PostgreSQL, добавьте расширение PostGIS через pgAdmin или psql

### Установка (универсально)

1. Клонируйте репозиторий:
   ```
   git clone <URL-репозитория>
   cd flooding
   ```
2. Создайте и активируйте виртуальное окружение:
   ```
   python -m venv .venv
   .venv\Scripts\activate  # Windows
   source .venv/bin/activate  # Linux/Mac
   ```
3. Установите зависимости:
   ```
   pip install -r requirements.txt
   # Для Windows: отдельно установите GDAL wheel
   ```
4. Создайте файл `.env`:
   ```
   DEBUG=True
   SECRET_KEY=your-secret-key
   DATABASE_URL=postgis://user:password@localhost:5432/floodportal
   ```
5. Примените миграции и создайте суперпользователя:
   ```
   python manage.py makemigrations
   python manage.py migrate
   python manage.py createsuperuser
   ```
6. Запустите Celery (или background tasks) и сервер:
   ```
   python manage.py process_tasks &  # или celery -A floodportal worker -l info
   python manage.py runserver
   ```
7. Откройте http://127.0.0.1:8000/

---

## Зависимости (requirements.txt)

- Django, djangorestframework, djangorestframework-gis, django-cors-headers, django-filter, django-celery-beat
- GDAL (wheel для Windows)
- pyproj, Shapely, Fiona, rasterio, folium, geopandas, Pillow
- numpy, pandas, scipy
- celery, redis, kombu
- psycopg2-binary, dj-database-url
- python-dateutil, requests, urllib3
- python-json-logger, geojson, PyYAML
- pytest, pytest-django, factory-boy
- drf-yasg, django-environ, python-dotenv
- pysheds, matplotlib, whitenoise, gunicorn
- django-background-tasks, django-redis

**См. полный список в requirements.txt**

---

## Использование геопортала

1. Зарегистрируйтесь и войдите в систему
2. Загрузите DEM и спутниковые снимки (Green, SWIR2)
3. Создайте анализ затопления, выберите файлы
4. Дождитесь завершения обработки (статус "Завершено")
5. Просматривайте результаты на карте, скачивайте статистику

---

## API и интеграции

- REST API для загрузки, анализа, получения результатов (см. flooddata/views.py)
- GeoJSON endpoints для карты (слои затопления, маски, события)
- (Опционально) интеграция с GeoServer через WMS/WFS

---

## Лицензия

MIT License

---

## Авторы и контакты

- [Укажите ваше имя и контакты]

---

## Вклад

Pull requests и предложения приветствуются! Открывайте issue или делайте merge request.